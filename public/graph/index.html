<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PolyVis | Graph Visualizer</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
  <script src="/components/nav.js"></script>
  <link rel="stylesheet" href="/css/app.css" />
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Alpine.js -->
  <script src="/js/app.js" defer></script>
</head>

<body class="page-layout" x-data="graphApp()" :class="{ 'loaded': loaded, 'layout-debug-mode': debug }"
  x-init="setTimeout(() => loaded = true, 50)" @keydown.window.shift.d="debug = !debug">

  <div class="app-shell">
    <header class="app-header">
      <div x-data="navigation" x-html="view"></div>
    </header>

    <aside class="app-sidebar-left">
      <div class="flex flex-col h-full overflow-y-auto min-h-0 p-4 gap-4">
        <h2 class="font-bold text-lg">Input Controls</h2>

        <div>
          <label class="block text-sm font-medium mb-1">Templates</label>
          <div class="flex flex-wrap gap-2">
            <button @click="loadTemplate('process')"
              class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded text-sm transition-colors">Process</button>
            <button @click="loadTemplate('stack')"
              class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-800 rounded text-sm transition-colors">Stack</button>
            <button @click="loadTemplate('network')"
              class="px-3 py-1 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded text-sm transition-colors">Network</button>
          </div>
        </div>

        <div class="flex-grow flex flex-col min-h-0">
          <label for="dotInput" class="block text-sm font-medium mb-1">DOT Input</label>
          <textarea id="dotInput" x-model="dotInput" @input.debounce.500ms="render()"
            class="flex-grow w-full resize-none bg-white text-black p-4 border border-gray-300 font-mono text-sm rounded shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 overflow-auto min-h-[200px]"
            placeholder="Enter DOT graph description here..."></textarea>
        </div>
      </div>
    </aside>

    <main class="app-main">
      <div class="flex flex-col h-full overflow-y-auto min-h-0 p-4 gap-4">
        <div class="flex justify-between items-center">
          <h2 class="font-bold text-lg">Graph Visualization</h2>
          <div class="flex gap-2 items-center">
            <span x-html="status" class="text-sm font-mono mr-2"></span>
            <button @click="saveSVG()" :disabled="!hasOutput"
              class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded text-sm disabled:opacity-50 transition-colors flex items-center gap-1">
              <i data-lucide="download" class="w-4 h-4"></i> SVG
            </button>
            <button @click="savePNG()" :disabled="!hasOutput"
              class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded text-sm disabled:opacity-50 transition-colors flex items-center gap-1">
              <i data-lucide="image" class="w-4 h-4"></i> PNG
            </button>
          </div>
        </div>

        <div id="graphOutputContainer" x-ref="graphOutput"
          class="flex-grow w-full grid place-items-center overflow-auto border border-gray-200 bg-white rounded shadow-inner min-h-[300px]">
          <p class="text-gray-400 font-mono text-sm">Waiting for input...</p>
        </div>

        <div class="border-t border-red-500 bg-red-50 p-2 font-mono text-xs text-red-700 rounded" x-show="error"
          x-text="error" style="display: none;">
        </div>
      </div>
    </main>

    <aside class="app-sidebar-right">
      <div class="flex flex-col h-full overflow-y-auto min-h-0 p-4 gap-4">
        <h2 class="font-bold text-lg">Analysis</h2>
        <div class="prose prose-sm">
          <p class="text-gray-600">Graph analysis tools and options will appear here.</p>
          <p class="text-gray-500 text-xs mt-4">
            Use the templates on the left to get started, or paste your own DOT code.
          </p>
        </div>
      </div>
    </aside>

    <footer class="app-footer text-center font-mono text-xs text-gray-400 flex items-center justify-center">
      &copy; 2025 PolyVis | Virtual Information Systems
    </footer>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('graphApp', () => ({
        viz: null,
        dotInput: '',
        status: 'Initializing System...',
        error: '',
        hasOutput: false,
        loaded: false,
        templates: {
          process: `digraph PolyVis {
      rankdir=TB;
      node [shape=box, style="filled", fillcolor="white", fontname="Courier", margin="0.2,0.1", penwidth=1];
      edge [fontname="Courier", fontsize=10];

      Input [label="Stuff (Input)", shape=plaintext];
      Output [label="Things (Output)", shape=plaintext];

      subgraph cluster_process {
          label = "PolyVis Process";
          style=dashed;
          color=grey;
          fontname="Courier";

          Analyze [label="Analyze\\n(Deconstruct)"];
          Structure [label="Structure\\n(Reassemble)"];
          Fold [label="Fold\\n(Refine)"];
      }

      Input -> Analyze;
      Analyze -> Structure;
      Structure -> Fold;
      Fold -> Output;
  }`,
          stack: `digraph PersonaStack {
      rankdir=TB;
      node [shape=record, fontname="Courier", margin="0.2,0.1", style=filled, fillcolor="white"];
      edge [fontname="Courier", fontsize=10];

      User [label="User (pjsvis)", shape=ellipse, fillcolor="#eee"];

      subgraph cluster_stack {
          label="The Persona Stack";
          style=solid;

          Persona [label="{Persona Layer|{CDA|CL}|Identity & Heuristics}"];
          Skin [label="{Skin Layer|{UI|Visuals}|Interface}"];
          Sleeve [label="{Sleeve Layer|{System Prompt|Tools}|Orchestration}"];
          Substrate [label="{Substrate Layer|{LLM|Compute}|Raw Intelligence}"];
      }

      User -> Skin [label="Interacts"];
      Skin -> Sleeve;
      Sleeve -> Persona;
      Persona -> Substrate;
  }`,
          network: `graph Network {
      layout=neato;
      overlap=false;
      node [shape=circle, style=filled, fillcolor="black", fontcolor="white", fontname="Courier", fixedsize=true, width=0.8];
      edge [color="#555"];

      Node1 [label="Poly"];
      Node2 [label="Vis"];
      Node3 [label="Data"];
      Node4 [label="Logic"];
      Node5 [label="Code"];

      Node1 -- Node2 [penwidth=3];
      Node1 -- Node3;
      Node2 -- Node4;
      Node3 -- Node5;
      Node4 -- Node5;
      Node2 -- Node5;
      Node3 -- Node4;
  }`,
        },

        init() {
          setTimeout(() => this.loaded = true, 50);
          this.$nextTick(() => { if (window.lucide) window.lucide.createIcons(); });
          try {
            if (typeof Viz === "undefined") throw new Error("Viz library not loaded.");
            this.viz = new Viz();
            this.status = "Ready.";
            this.$nextTick(() => {
              this.loadTemplate('process');
            });
          } catch (e) {
            console.error("Viz init failed:", e);
            this.status = `<span class="text-red-500">System Error: ${e.message}</span>`;
          }
        },

        debug: false, // Added for layout debug mode

        loadTemplate(name) {
          if (this.templates[name]) {
            this.dotInput = this.templates[name];
            this.render();
          }
        },

        render() {
          const dotString = this.dotInput.trim();
          this.status = "Processing...";
          this.error = "";
          this.hasOutput = false;
          this.$refs.graphOutput.innerHTML = '<p class="font-mono text-xs text-gray-400">Processing...</p>';

          if (!dotString) {
            this.status = "Input Empty.";
            this.$refs.graphOutput.innerHTML = '<p class="font-mono text-xs text-gray-400">Input Empty.</p>';
            return;
          }

          if (!this.viz) {
            this.error = "Error: Engine not initialized.";
            return;
          }

          this.viz.renderSVGElement(dotString)
            .then((element) => {
              this.$refs.graphOutput.innerHTML = "";
              // element.setAttribute("width", "100%");
              // element.setAttribute("height", "100%");
              this.$refs.graphOutput.appendChild(element);
              this.hasOutput = true;
              this.status = "";
            })
            .catch((error) => {
              console.error(error);
              this.$refs.graphOutput.innerHTML = "";
              this.error = `SYNTAX ERROR: ${error.message}`;
            });
        },

        saveSVG() {
          const svg = this.$refs.graphOutput.querySelector("svg");
          if (!svg) return;
          if (!svg.getAttribute("xmlns")) svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
          const data = new XMLSerializer().serializeToString(svg);
          const blob = new Blob([data], { type: "image/svg+xml;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "polyvis_graph.svg";
          a.click();
          URL.revokeObjectURL(url);
        },

        savePNG() {
          const svg = this.$refs.graphOutput.querySelector("svg");
          if (!svg) return;
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const tempSvg = svg.cloneNode(true);
          const bbox = svg.getBBox();
          const scale = 2;
          const padding = 40;
          canvas.width = (bbox.width + padding) * scale;
          canvas.height = (bbox.height + padding) * scale;
          tempSvg.setAttribute("width", canvas.width);
          tempSvg.setAttribute("height", canvas.height);
          tempSvg.setAttribute("viewBox", `${bbox.x - padding / 2} ${bbox.y - padding / 2} ${bbox.width + padding} ${bbox.height + padding}`);
          const data = new XMLSerializer().serializeToString(tempSvg);
          const img = new Image();
          img.onload = () => {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            const a = document.createElement("a");
            a.href = canvas.toDataURL("image/png");
            a.download = "polyvis_graph.png";
            a.click();
          };
          img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(data)));
        }
      }));
    });
  </script>
</body>

</html>