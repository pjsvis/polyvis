<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light">
    <title>PolyVis | Layout Test</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Inline Theme Init to prevent FOUC -->
    <script>
        (function () {
            const stored = localStorage.getItem('polyvis-theme');
            if (stored) {
                document.documentElement.setAttribute('data-theme', stored);
            }
        })();
    </script>
    <script src="/js/app.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://unpkg.com/graphology@0.25.4/dist/graphology.umd.js"></script>
    <script src="https://unpkg.com/sigma@2.4.0/build/sigma.min.js"></script>
    <script src="https://unpkg.com/graphology-library@0.8.0/dist/graphology-library.min.js"></script>
    <link rel="stylesheet" href="/css/app.css" />
    <style>

    </style>
</head>

<!-- 
  STRICT FLEX LAYOUT SKELETON
  1. Body: Viewport Container
  2. Outer Flex: Navbar + Main
  3. Main Flex: Left + Graph + Right
-->

<body class="h-screen w-screen overflow-hidden text-sm antialiased" style="background-color: var(--accent);"
    x-data="sigmaApp()" :class="{ 'loaded': loaded, 'layout-debug-mode': debug }"
    @keydown.window.shift.d="debug = !debug">



    <!-- Outer Flex Container (Vertical) -->
    <div class="flex h-full w-full flex-col">

        <!-- 1. Navbar (Fixed Height) -->
        <header class="app-header">
            <div x-data="navigation" x-html="view"></div>
        </header>

        <!-- 2. Main Content (Fills remaining height) -->
        <div class="flex flex-row flex-nowrap flex-grow overflow-hidden relative">

            <!-- 2a. Left Sidebar (Fixed Width, Collapsible) -->
            <div x-show="leftOpen" style="width: var(--sidebar-width-left)"
                class="flex-shrink-0 flex flex-col border-r border-gray-300 bg-gray-50 shadow-sm transition-all z-20"
                x-transition:enter="transition ease-out duration-200" x-transition:enter-start="-translate-x-full"
                x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full">
                <div class="flex items-center justify-between p-2 border-b border-gray-200 bg-gray-200">
                    <span class="font-mono text-xs font-bold uppercase text-gray-600">Controls</span>
                    <button @click="leftOpen = false" class="text-gray-500 hover:text-black">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Sidebar Content -->
                <div class="flex-grow overflow-y-auto p-4 space-y-4">
                    <!-- Analysis Group -->
                    <div>
                        <div class="mb-2 font-mono text-[10px] font-bold uppercase text-gray-400">Analysis</div>
                        <div class="space-y-2">
                            <!-- Louvain -->
                            <div class="group relative">
                                <button class="btn-structural w-full justify-start gap-1 text-xs"
                                    :class="{ 'active': activeColorViz === 'louvain' }"
                                    @click="toggleColorViz('louvain')"
                                    @mouseenter="showTooltip($event, 'Detects communities (clusters) and colors nodes to show group membership.')"
                                    @mouseleave="hideTooltip()">
                                    <i data-lucide="users" class="h-3 w-3"></i> Louvain
                                </button>
                            </div>

                            <!-- PageRank -->
                            <div class="group relative">
                                <button class="btn-structural w-full justify-start gap-1 text-xs"
                                    :class="{ 'active': activeSizeViz === 'pagerank' }"
                                    @click="toggleSizeViz('pagerank')"
                                    @mouseenter="showTooltip($event, 'Sizes nodes based on their influence. Larger nodes are more \'important\'.')"
                                    @mouseleave="hideTooltip()">
                                    <i data-lucide="bar-chart-2" class="h-3 w-3"></i> PageRank
                                </button>
                            </div>

                            <!-- Degree -->
                            <div class="group relative">
                                <button class="btn-structural w-full justify-start gap-1 text-xs"
                                    :class="{ 'active': activeSizeViz === 'degree' }" @click="toggleSizeViz('degree')"
                                    @mouseenter="showTooltip($event, 'Sizes nodes by connection count. Larger nodes have more direct connections.')"
                                    @mouseleave="hideTooltip()">
                                    <i data-lucide="circle" class="h-3 w-3"></i> Degree
                                </button>
                            </div>

                            <!-- Betweenness -->
                            <div class="group relative">
                                <button class="btn-structural w-full justify-start gap-1 text-xs"
                                    :class="{ 'active': activeColorViz === 'betweenness' }"
                                    @click="toggleColorViz('betweenness')"
                                    @mouseenter="showTooltip($event, 'Colors nodes based on \'bridging\' score. Redder nodes lie on more shortest paths.')"
                                    @mouseleave="hideTooltip()">
                                    <i data-lucide="git-commit" class="h-3 w-3"></i> Betweenness
                                </button>
                            </div>

                            <!-- Components -->
                            <div class="group relative">
                                <button class="btn-structural w-full justify-start gap-1 text-xs"
                                    :class="{ 'active': activeColorViz === 'components' }"
                                    @click="toggleColorViz('components')"
                                    @mouseenter="showTooltip($event, 'Highlights the largest connected group of nodes in Green.')"
                                    @mouseleave="hideTooltip()">
                                    <i data-lucide="share-2" class="h-3 w-3"></i> Components
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Layout Group -->
                    <div>
                        <div class="mb-2 font-mono text-[10px] font-bold uppercase text-gray-400">Layout</div>
                        <div class="group relative">
                            <select x-model="layout" @change="runLayout($event.target.value)"
                                class="btn-structural w-full text-xs" style="cursor: pointer;"
                                @mouseenter="showTooltip($event, 'Select an algorithm to automatically arrange the nodes.')"
                                @mouseleave="hideTooltip()">
                                <option value="forceatlas2">ForceAtlas2</option>
                                <option value="circular">Circular</option>
                                <option value="random">Random</option>
                                <option value="noverlap">Noverlap</option>
                            </select>
                        </div>
                    </div>

                    <!-- Actions Group -->
                    <div>
                        <div class="mb-2 font-mono text-[10px] font-bold uppercase text-gray-400">Actions</div>
                        <button @click="toggleStats()" class="btn-structural w-full justify-start gap-1 text-xs"
                            :class="{ 'active': showStats }">
                            <i data-lucide="info" class="h-3 w-3"></i> Toggle Stats
                        </button>
                    </div>

                    <!-- Help Group -->
                    <div class="pt-4 border-t border-gray-100">
                        <!-- Search Bar (Moved here) -->
                        <div class="mb-4 relative">
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-2 top-2.5 h-3 w-3 text-gray-400"></i>
                                <input type="text" x-model="searchQuery" @input="handleSearch()"
                                    @focus="isSearchFocused = true; handleSearch()"
                                    @blur="setTimeout(() => isSearchFocused = false, 200)" placeholder="Search nodes..."
                                    class="w-full pl-7 pr-2 py-1.5 text-xs border border-gray-300 rounded focus:outline-none focus:border-black focus:ring-1 focus:ring-black transition-colors">
                            </div>

                            <!-- Search Results Dropdown (Downwards) -->
                            <div x-show="isSearchFocused && searchResults.length > 0"
                                class="absolute left-0 right-0 top-full mt-1 bg-white border border-gray-200 rounded shadow-lg max-h-60 overflow-y-auto z-50"
                                x-transition.opacity>

                                <div x-show="!searchQuery"
                                    class="px-2 py-1 text-[10px] uppercase text-gray-400 font-bold bg-gray-50 border-b border-gray-100">
                                    Suggested Concepts
                                </div>

                                <template x-for="node in searchResults" :key="node.id">
                                    <button @click="selectSearchResult(node.id)"
                                        class="w-full text-left px-3 py-2 text-xs hover:bg-gray-100 border-b border-gray-50 last:border-0 flex flex-col gap-0.5">
                                        <span class="font-bold text-gray-800" x-text="node.label"></span>
                                        <span class="font-mono text-[10px] text-gray-400" x-text="node.id"></span>
                                    </button>
                                </template>
                            </div>
                        </div>

                        <div class="mb-2 font-mono text-[10px] font-bold uppercase text-gray-600">Help</div>
                        <div class="text-[10px] text-gray-800 space-y-2 leading-relaxed font-mono">
                            <p>Push buttons to show graph features and click nodes to see details.</p>
                            <p>Use zoom controls to zoom and click & drag to move the graph.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2b. Graph Panel (Fills remaining width) -->
            <div class="flex-grow bg-gray-200 relative overflow-hidden">

                <!-- Open Left Sidebar Button -->
                <button x-show="!leftOpen" @click="leftOpen = true"
                    class="absolute left-0 top-4 bg-white p-1 border rounded-r shadow hover:bg-gray-50 z-10">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>

                <!-- Open Right Sidebar Button -->
                <button x-show="!rightOpen" @click="rightOpen = true"
                    class="absolute right-0 top-4 bg-white p-1 border rounded-l shadow hover:bg-gray-50 z-10">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </button>

                <!-- Graph Container -->
                <div id="sigma-container" class="absolute inset-0 z-0" x-ref="sigmaContainer"></div>

                <!-- Floating Stats Panel (Bottom Left) -->
                <div x-show="showStats"
                    class="absolute bottom-6 left-6 min-w-[200px] rounded-md border border-gray-300 bg-white/95 p-4 shadow-lg z-10 font-mono text-xs"
                    x-transition.opacity>
                    <div class="mb-2 border-b border-gray-200 pb-1 font-bold">Graph Statistics</div>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                        <span class="text-gray-500">Nodes:</span> <span x-text="stats.nodes" class="font-bold"></span>
                        <span class="text-gray-500">Edges:</span> <span x-text="stats.edges" class="font-bold"></span>
                        <span class="text-gray-500">Density:</span> <span x-text="stats.density"
                            class="font-bold"></span>
                        <span class="text-gray-500">Avg Deg:</span> <span x-text="stats.avgDegree"
                            class="font-bold"></span>
                    </div>
                </div>

                <!-- Floating Zoom Controls (Top Right) -->
                <div
                    class="absolute top-4 right-14 flex flex-col gap-2 rounded-md border border-gray-300 bg-white/90 p-2 shadow-sm z-10">
                    <button class="btn-structural" @click="zoomIn()" title="Zoom In">
                        <i data-lucide="zoom-in" class="h-4 w-4"></i>
                    </button>
                    <button class="btn-structural" @click="zoomReset()" title="Reset Camera">
                        <i data-lucide="maximize" class="h-4 w-4"></i>
                    </button>
                    <button class="btn-structural" @click="zoomOut()" title="Zoom Out">
                        <i data-lucide="zoom-out" class="h-4 w-4"></i>
                    </button>
                </div>
            </div>

            <!-- 2c. Right Sidebar (Fixed Width, Collapsible) -->
            <div x-show="rightOpen" id="right-sidebar-override" style="width: var(--sidebar-width-right)"
                class="flex-shrink-0 flex flex-col border-l border-gray-300 !bg-white !text-black shadow-sm transition-all z-20"
                x-transition:enter="transition ease-out duration-200" x-transition:enter-start="translate-x-full"
                x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="translate-x-0" x-transition:leave-end="translate-x-full">
                <div
                    class="flex items-center justify-between p-2 border-b border-gray-200 bg-gray-200 !bg-gray-200 !text-black">
                    <button @click="rightOpen = false" class="text-gray-500 hover:text-black !text-gray-600">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                    <span class="font-mono text-xs font-bold uppercase text-gray-600 !text-black">Details</span>
                </div>

                <div class="flex-grow overflow-y-auto p-4 space-y-6">
                    <!-- Help Section (Collapsible) -->
                    <div>
                        <details x-ref="analysisGuide"
                            class="group open:bg-gray-50 open:ring-1 open:ring-black/5 rounded-lg p-2 transition-all duration-300"
                            open>
                            <summary
                                class="flex items-center justify-between cursor-pointer list-none font-bold text-xs text-gray-500 !text-black uppercase tracking-wider">
                                <span>Analysis Guide</span>
                                <span class="transition group-open:rotate-180">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </span>
                            </summary>

                            <div class="text-xs !text-gray-800 space-y-2 leading-relaxed font-mono mt-2">
                                <p><strong>Welcome to the Knowledge Graph.</strong></p>
                                <p>This interactive map visualizes the relationships between key concepts.</p>
                                <ul class="list-disc pl-4 space-y-1">
                                    <li><strong>Nodes</strong> represent individual entities or concepts.</li>
                                    <li><strong>Lines</strong> show the connections between them.</li>
                                    <li><strong>Colors</strong> indicate communities or clusters of related topics.</li>
                                    <li><strong>Size</strong> reflects the importance or influence of a node within the
                                        network.</li>
                                </ul>
                                <p class="mt-2">Use the controls on the left to explore different perspectives and click
                                    on any node to dive deeper into its details.</p>
                            </div>
                        </details>
                    </div>

                    <!-- Node Details Section -->
                    <div x-show="selectedNode" class="space-y-4 border-t border-gray-100 pt-4"
                        x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 translate-y-2"
                        x-transition:enter-end="opacity-100 translate-y-0">

                        <div class="flex items-center justify-between pb-2">
                            <div class="text-xs text-gray-500 !text-gray-600 uppercase font-bold tracking-wider">Node
                                Data</div>
                            <button @click="selectedNode = null"
                                class="text-gray-400 hover:text-gray-600 !text-gray-500">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>

                        <template x-if="selectedNode">
                            <div class="space-y-4 animate-in fade-in slide-in-from-right-4 duration-300">
                                <div>
                                    <div
                                        class="text-[10px] uppercase text-gray-400 !text-gray-500 font-bold tracking-wider mb-1">
                                        Label
                                    </div>
                                    <div class="text-sm font-bold text-gray-900 !text-black"
                                        x-text="selectedNode.label"></div>
                                </div>

                                <div>
                                    <div class="text-[10px] uppercase text-gray-400 font-bold tracking-wider mb-1">Type
                                    </div>
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"
                                        x-text="selectedNode.nodeType"></span>
                                </div>

                                <div>
                                    <div class="text-[10px] uppercase text-gray-400 font-bold tracking-wider mb-1">
                                        Definition</div>
                                    <div class="text-xs text-gray-600 leading-relaxed font-mono"
                                        x-html="linkify(selectedNode.definition || 'No definition available.')"
                                        @click="handleContentClick($event)"></div>
                                </div>

                                <div class="pt-4 border-t border-gray-100">
                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <div>
                                            <span class="text-gray-400">Degree:</span>
                                            <span class="font-mono ml-1"
                                                x-text="graph ? graph.degree(selectedNode.id) : 0"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400">ID:</span>
                                            <span class="font-mono ml-1 truncate" x-text="selectedNode.id"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- External References -->
                            <template x-if="selectedNode.external_refs && selectedNode.external_refs.length > 0">
                                <div class="pt-4 border-t border-gray-100">
                                    <div class="text-[10px] uppercase text-gray-400 font-bold tracking-wider mb-2">
                                        External References</div>
                                    <div class="space-y-2">
                                        <template x-for="ref in selectedNode.external_refs" :key="ref.url">
                                            <a :href="ref.url" target="_blank"
                                                class="flex items-center justify-between p-2 rounded border border-gray-200 hover:bg-gray-50 hover:border-black transition-colors group">
                                                <div class="flex items-center gap-2">
                                                    <i data-lucide="external-link"
                                                        class="w-3 h-3 text-gray-400 group-hover:text-black"></i>
                                                    <span class="text-xs font-mono text-gray-600 group-hover:text-black"
                                                        x-text="ref.label"></span>
                                                </div>
                                                <span
                                                    class="text-[10px] uppercase text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded"
                                                    x-text="ref.type"></span>
                                            </a>
                                        </template>
                                    </div>
                                </div>
                            </template>
                    </div>
                    </template>

                </div>
            </div>
        </div>

    </div>

    </div>


    if (this.activeSizeViz === type) {
    this.resetSizes();
    this.activeSizeViz = null;
    if (this.renderer) this.renderer.refresh();
    return;
    }

    this.resetSizes();
    this.activeSizeViz = type;

    if (!graphologyLibrary.metrics) return alert("Metrics library not loaded.");

    if (type === 'pagerank') {
    const scores = graphologyLibrary.metrics.centrality.pagerank(this.graph);
    const minScore = Math.min(...Object.values(scores));
    const maxScore = Math.max(...Object.values(scores));
    this.graph.forEachNode((node) => {
    // User Request: Ensure min size is 6px (reduced again)
    this.graph.setNodeAttribute(node, "size", 6 + ((scores[node] - minScore) / (maxScore - minScore)) * 14);
    });
    } else if (type === 'degree') {
    const scores = graphologyLibrary.metrics.centrality.degree(this.graph);
    const minScore = Math.min(...Object.values(scores));
    const maxScore = Math.max(...Object.values(scores));
    this.graph.forEachNode((node) => {
    // User Request: Ensure min size is 6px (reduced again)
    this.graph.setNodeAttribute(node, "size", 6 + ((scores[node] - minScore) / (maxScore - minScore)) * 14);
    });
    }
    if (this.renderer) this.renderer.refresh();
    },

    runLayout(layoutName) {
    this.layout = layoutName;
    const lib = window.graphologyLibrary;
    if (!lib) return;

    if (layoutName === 'forceatlas2') {
    if (lib.layoutForceAtlas2) {
    lib.layoutForceAtlas2.assign(this.graph, { iterations: 50, settings: { gravity: 1 } });
    }
    } else if (layoutName === 'circular') {
    if (lib.layout && lib.layout.circular) lib.layout.circular.assign(this.graph);
    } else if (layoutName === 'random') {
    if (lib.layout && lib.layout.random) lib.layout.random.assign(this.graph);
    } else if (layoutName === 'noverlap') {
    if (lib.layoutNoverlap) lib.layoutNoverlap.assign(this.graph);
    }

    if (this.renderer) {
    this.renderer.refresh();
    this.renderer.getCamera().animatedReset();
    }
    },

    toggleStats() {
    this.showStats = !this.showStats;
    if (this.showStats) {
    this.stats.nodes = this.graph.order;
    this.stats.edges = this.graph.size;
    this.stats.density = graphologyLibrary.metrics.graph.density(this.graph).toFixed(4);
    this.stats.avgDegree = ((2 * this.stats.edges) / this.stats.nodes).toFixed(2);
    }
    }
    }));
    });
    </script>
    <div x-show="tooltip.visible" x-transition.opacity
        class="fixed z-50 p-2 bg-black text-white text-xs font-bold rounded shadow-lg pointer-events-none max-w-xs"
        :style="`top: ${tooltip.y}px; left: ${tooltip.x}px`" x-text="tooltip.text">
    </div>
</body>

</html>