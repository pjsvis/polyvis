<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PolyVis | Sigma Explorer</title>

  <link rel="stylesheet" href="/css/style.css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="https://unpkg.com/graphology@0.25.4/dist/graphology.umd.js"></script>
  <script src="https://unpkg.com/sigma@2.4.0/build/sigma.min.js"></script>
  <script src="https://unpkg.com/graphology-library@0.8.0/dist/graphology-library.min.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Alpine.js -->
  <script src="//unpkg.com/alpinejs" defer></script>

  <link rel="stylesheet" href="css/style.css" />
</head>

<!-- 
  STRICT FLEX LAYOUT:
  1. Body: h-screen w-screen overflow-hidden (Viewport Container)
  2. Outer Flex (Col): Navbar (Fixed) + Main (Grow)
  3. Main Flex (Row): Left Sidebar (Fixed/Collapsible) + Graph (Grow) + Right Sidebar (Fixed/Collapsible)
-->

<body class="h-screen w-screen overflow-hidden bg-gray-100 text-sm antialiased" x-data="sigmaApp()"
  :class="{ 'loaded': loaded }">

  <script src="/components/nav.js"></script>

  <!-- Outer Flex Container (Vertical) -->
  <div class="flex h-full w-full flex-col" x-data="{ leftOpen: true, rightOpen: true }">

    <!-- Item 1: Navbar -->
    <div class="flex-none border-b border-gray-300 bg-white">
      <div x-data="navigation" x-html="view"></div>
    </div>

    <!-- Item 2: Main Content (Horizontal Flex) -->
    <div class="flex flex-row flex-nowrap flex-grow overflow-hidden relative">

      <!-- Horizontal Item 1: Left Sidebar -->
      <div x-show="leftOpen"
        class="flex flex-none w-64 flex-col border-r border-gray-300 bg-white shadow-sm transition-all z-20"
        x-transition:enter="transition ease-out duration-200" x-transition:enter-start="-translate-x-full"
        x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full">

        <!-- Sidebar Header -->
        <div class="flex items-center justify-between border-b border-gray-200 p-2 bg-gray-50">
          <span class="font-mono text-xs font-bold uppercase text-gray-600">Controls</span>
          <button @click="leftOpen = false" class="text-gray-500 hover:text-black" title="Collapse Sidebar">
            <i data-lucide="chevron-left" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Sidebar Content -->
        <div class="flex-grow overflow-y-auto p-4 space-y-4">
          <!-- Analysis Group -->
          <div>
            <div class="mb-2 font-mono text-[10px] font-bold uppercase text-gray-400">Analysis</div>
            <div class="space-y-2">
              <button class="btn-structural w-full justify-start text-xs"
                :class="{ 'active': activeColorViz === 'louvain' }" @click="toggleColor('louvain')">
                <i data-lucide="users" class="h-3 w-3"></i> Louvain
              </button>
              <button class="btn-structural w-full justify-start text-xs"
                :class="{ 'active': activeSizeViz === 'pagerank' }" @click="toggleSize('pagerank')">
                <i data-lucide="bar-chart-2" class="h-3 w-3"></i> PageRank
              </button>
              <button class="btn-structural w-full justify-start text-xs"
                :class="{ 'active': activeSizeViz === 'degree' }" @click="toggleSize('degree')">
                <i data-lucide="circle" class="h-3 w-3"></i> Degree
              </button>
              <button class="btn-structural w-full justify-start text-xs"
                :class="{ 'active': activeColorViz === 'betweenness' }" @click="toggleColor('betweenness')">
                <i data-lucide="git-commit" class="h-3 w-3"></i> Betweenness
              </button>
              <button class="btn-structural w-full justify-start text-xs"
                :class="{ 'active': activeColorViz === 'components' }" @click="toggleColor('components')">
                <i data-lucide="share-2" class="h-3 w-3"></i> Components
              </button>
            </div>
          </div>

          <!-- Layout Group -->
          <div>
            <div class="mb-2 font-mono text-[10px] font-bold uppercase text-gray-400">Layout</div>
            <select x-model="layout" @change="runLayout($event.target.value)" class="btn-structural w-full text-xs"
              style="cursor: pointer;">
              <option value="forceatlas2">ForceAtlas2</option>
              <option value="circular">Circular</option>
              <option value="random">Random</option>
              <option value="noverlap">Noverlap</option>
            </select>
          </div>

          <!-- Actions Group -->
          <div>
            <div class="mb-2 font-mono text-[10px] font-bold uppercase text-gray-400">Actions</div>
            <button @click="toggleStats()" class="btn-structural w-full justify-start text-xs"
              :class="{ 'active': showStats }">
              <i data-lucide="info" class="h-3 w-3"></i> Toggle Stats
            </button>
          </div>
        </div>
      </div>

      <!-- Horizontal Item 2: Graph Panel -->
      <div class="relative flex-grow bg-gray-100 overflow-hidden">

        <!-- Expand Left Sidebar Button (Absolute) -->
        <button x-show="!leftOpen" @click="leftOpen = true"
          class="absolute left-0 top-4 z-20 rounded-r-md border border-l-0 border-gray-300 bg-white p-1 shadow-sm hover:bg-gray-50"
          title="Expand Controls">
          <i data-lucide="chevron-right" class="h-4 w-4"></i>
        </button>

        <!-- Expand Right Sidebar Button (Absolute) -->
        <button x-show="!rightOpen" @click="rightOpen = true"
          class="absolute right-0 top-4 z-20 rounded-l-md border border-r-0 border-gray-300 bg-white p-1 shadow-sm hover:bg-gray-50"
          title="Expand Details">
          <i data-lucide="chevron-left" class="h-4 w-4"></i>
        </button>

        <!-- Graph Container -->
        <div id="sigma-container" class="absolute inset-0 z-0" x-ref="sigmaContainer"></div>

        <!-- Floating Stats Panel (Bottom Left) -->
        <div x-show="showStats"
          class="absolute bottom-6 left-6 min-w-[200px] rounded-md border border-gray-300 bg-white/95 p-4 shadow-lg z-10 font-mono text-xs"
          x-transition.opacity>
          <div class="mb-2 border-b border-gray-200 pb-1 font-bold">Graph Statistics</div>
          <div class="grid grid-cols-2 gap-x-4 gap-y-1">
            <span class="text-gray-500">Nodes:</span> <span x-text="stats.nodes" class="font-bold"></span>
            <span class="text-gray-500">Edges:</span> <span x-text="stats.edges" class="font-bold"></span>
            <span class="text-gray-500">Density:</span> <span x-text="stats.density" class="font-bold"></span>
            <span class="text-gray-500">Avg Deg:</span> <span x-text="stats.avgDegree" class="font-bold"></span>
          </div>
        </div>

        <!-- Floating Zoom Controls (Bottom Right) -->
        <div
          class="absolute bottom-6 right-6 flex flex-col gap-2 rounded-md border border-gray-300 bg-white/90 p-2 shadow-sm z-10">
          <button class="btn-structural" @click="zoomIn()" title="Zoom In">
            <i data-lucide="zoom-in" class="h-4 w-4"></i>
          </button>
          <button class="btn-structural" @click="zoomOut()" title="Zoom Out">
            <i data-lucide="zoom-out" class="h-4 w-4"></i>
          </button>
          <button class="btn-structural" @click="resetZoom()" title="Reset Camera">
            <i data-lucide="maximize" class="h-4 w-4"></i>
          </button>
        </div>
      </div>

      <!-- Horizontal Item 3: Right Sidebar -->
      <div x-show="rightOpen"
        class="flex flex-none w-64 flex-col border-l border-gray-300 bg-white shadow-sm transition-all z-20"
        x-transition:enter="transition ease-out duration-200" x-transition:enter-start="translate-x-full"
        x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="translate-x-0" x-transition:leave-end="translate-x-full">

        <!-- Sidebar Header -->
        <div class="flex items-center justify-between border-b border-gray-200 p-2 bg-gray-50">
          <button @click="rightOpen = false" class="text-gray-500 hover:text-black" title="Collapse Sidebar">
            <i data-lucide="chevron-right" class="h-4 w-4"></i>
          </button>
          <span class="font-mono text-xs font-bold uppercase text-gray-600">Details</span>
        </div>

        <!-- Sidebar Content -->
        <div class="flex-grow overflow-y-auto p-4 prose prose-sm">
          <p class="text-xs text-gray-600">
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et
            dolore magna aliqua.
          </p>
          <p class="text-xs text-gray-600 mt-2">
            Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
          </p>
        </div>
      </div>

    </div>
  </div>


  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('sigmaApp', () => ({
        status: 'Initializing...',
        graph: null,
        renderer: null,
        activeColorViz: null,
        activeSizeViz: null,
        layout: 'forceatlas2',
        showStats: false,
        stats: { nodes: 0, edges: 0, density: 0, avgDegree: 0 },
        loaded: false,

        init() {
          setTimeout(() => this.loaded = true, 50);
          this.initSqlJs();
          this.$nextTick(() => { if (window.lucide) window.lucide.createIcons(); });
        },

        initSqlJs() {
          initSqlJs({
            locateFile: (file) => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`,
          }).then((SQL) => {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", "/data/ctx.db", true);
            xhr.responseType = "arraybuffer";

            xhr.onload = (e) => {
              if (xhr.status !== 200) {
                this.status = `<span class="text-red-500">Error: ctx.db not found (Status ${xhr.status})</span>`;
                return;
              }
              const uInt8Array = new Uint8Array(xhr.response);
              const db = new SQL.Database(uInt8Array);
              this.loadGraph(db);
            };
            xhr.send();
          });
        },

        loadGraph(db) {
          // 1. Instantiate Graphology
          this.graph = new graphology.Graph();
          this.status = "Extracting Data...";

          // 2. Query Nodes
          try {
            const nodesStmt = db.prepare("SELECT * FROM nodes");
            while (nodesStmt.step()) {
              const row = nodesStmt.getAsObject();
              this.graph.addNode(row.id, {
                label: row.label,
                size: row.type === "Core Concept" ? 15 : 5,
                color: row.type === "Core Concept" ? "black" : "#999",
                originalSize: row.type === "Core Concept" ? 15 : 5,
                originalColor: row.type === "Core Concept" ? "black" : "#999",
                x: Math.random() * 100,
                y: Math.random() * 100,
              });
            }
          } catch (e) {
            console.error("Node Error", e);
          }

          // 3. Query Edges
          try {
            const edgesStmt = db.prepare("SELECT * FROM edges");
            while (edgesStmt.step()) {
              const row = edgesStmt.getAsObject();
              if (this.graph.hasNode(row.source) && this.graph.hasNode(row.target)) {
                if (!this.graph.hasEdge(row.source, row.target)) {
                  this.graph.addEdge(row.source, row.target, {
                    type: "arrow",
                    label: row.relation,
                    size: 2,
                    color: "#e5e5e5",
                  });
                }
              }
            }
          } catch (e) {
            console.error("Edge Error", e);
          }

          const nodeCount = this.graph.order;
          const edgeCount = this.graph.size;
          this.status = `Graph Loaded: ${nodeCount} Nodes, ${edgeCount} Edges. Running Physics...`;

          // 4. Run Layout (ForceAtlas2)
          this.runLayout('forceatlas2');

          // 5. Render with Sigma
          const container = this.$refs.sigmaContainer;
          container.innerHTML = ""; // Clear previous

          this.renderer = new Sigma(this.graph, container, {
            renderEdgeLabels: true,
          });

          // Disable mouse wheel zoom
          try {
            if (this.renderer.getMouseCaptor()) {
              this.renderer.getMouseCaptor().isMouseWheelEnabled = false;
            }
          } catch (e) { }

          container.addEventListener("wheel", (e) => e.stopPropagation(), true);

          this.status = "Interactive Mode Active. Buttons to Zoom, Drag to Move.";
        },

        zoomIn() {
          if (!this.renderer) return;
          const camera = this.renderer.getCamera();
          camera.animate({ ratio: camera.ratio / 1.5 });
        },

        zoomOut() {
          if (!this.renderer) return;
          const camera = this.renderer.getCamera();
          camera.animate({ ratio: camera.ratio * 1.5 });
        },

        zoomReset() {
          if (!this.renderer) return;
          this.renderer.getCamera().animatedReset();
        },

        resetColors() {
          this.graph.forEachNode((node, attributes) => {
            if (attributes.originalColor) this.graph.setNodeAttribute(node, "color", attributes.originalColor);
          });
        },

        resetSizes() {
          this.graph.forEachNode((node, attributes) => {
            if (attributes.originalSize) this.graph.setNodeAttribute(node, "size", attributes.originalSize);
          });
        },

        toggleColorViz(type) {
          if (this.activeColorViz === type) {
            this.resetColors();
            this.activeColorViz = null;
            this.renderer.refresh();
            return;
          }

          this.resetColors();
          this.activeColorViz = type;

          if (type === 'louvain') {
            if (!graphologyLibrary.communitiesLouvain) return alert("Louvain library not loaded.");
            const communities = graphologyLibrary.communitiesLouvain(this.graph);
            const colors = ["#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4", "#46f0f0", "#f032e6", "#bcf60c", "#fabebe", "#008080", "#e6beff", "#9a6324", "#fffac8", "#800000", "#aaffc3", "#808000", "#ffd8b1", "#000075", "#808080", "#ffffff", "#000000"];
            this.graph.forEachNode((node) => {
              this.graph.setNodeAttribute(node, "color", colors[communities[node] % colors.length]);
            });
          } else if (type === 'betweenness') {
            if (!graphologyLibrary.metrics) return alert("Metrics library not loaded.");
            const scores = graphologyLibrary.metrics.centrality.betweenness(this.graph);
            const minScore = Math.min(...Object.values(scores));
            const maxScore = Math.max(...Object.values(scores));
            this.graph.forEachNode((node) => {
              const normalized = (scores[node] - minScore) / (maxScore - minScore);
              const r = 255;
              const g = Math.floor(255 * (1 - normalized * 0.8));
              const b = Math.floor(255 * (1 - normalized));
              this.graph.setNodeAttribute(node, "color", `rgb(${r}, ${g}, ${b})`);
            });
          } else if (type === 'components') {
            if (!graphologyLibrary.components) return alert("Components library not loaded.");
            const componentArrays = graphologyLibrary.components.connectedComponents(this.graph);
            let largestComponent = [];
            componentArrays.forEach(comp => {
              if (comp.length > largestComponent.length) largestComponent = comp;
            });
            const largestComponentSet = new Set(largestComponent);
            this.graph.forEachNode((node) => {
              this.graph.setNodeAttribute(node, "color", largestComponentSet.has(node) ? "#3cb44b" : "#cccccc");
            });
          }
          this.renderer.refresh();
        },

        toggleSizeViz(type) {
          if (this.activeSizeViz === type) {
            this.resetSizes();
            this.activeSizeViz = null;
            this.renderer.refresh();
            return;
          }

          this.resetSizes();
          this.activeSizeViz = type;

          if (!graphologyLibrary.metrics) return alert("Metrics library not loaded.");

          if (type === 'pagerank') {
            const scores = graphologyLibrary.metrics.centrality.pagerank(this.graph);
            const minScore = Math.min(...Object.values(scores));
            const maxScore = Math.max(...Object.values(scores));
            this.graph.forEachNode((node) => {
              this.graph.setNodeAttribute(node, "size", 3 + ((scores[node] - minScore) / (maxScore - minScore)) * 27);
            });
          } else if (type === 'degree') {
            const scores = graphologyLibrary.metrics.centrality.degree(this.graph);
            const minScore = Math.min(...Object.values(scores));
            const maxScore = Math.max(...Object.values(scores));
            this.graph.forEachNode((node) => {
              this.graph.setNodeAttribute(node, "size", 4 + ((scores[node] - minScore) / (maxScore - minScore)) * 21);
            });
          }
          this.renderer.refresh();
        },

        runLayout(layoutName) {
          this.layout = layoutName;
          const lib = window.graphologyLibrary;
          if (!lib) return;

          if (layoutName === 'forceatlas2') {
            if (lib.layoutForceAtlas2) {
              lib.layoutForceAtlas2.assign(this.graph, { iterations: 50, settings: { gravity: 1 } });
            }
          } else if (layoutName === 'circular') {
            if (lib.layout && lib.layout.circular) lib.layout.circular.assign(this.graph);
          } else if (layoutName === 'random') {
            if (lib.layout && lib.layout.random) lib.layout.random.assign(this.graph);
          } else if (layoutName === 'noverlap') {
            if (lib.layoutNoverlap) lib.layoutNoverlap.assign(this.graph);
          }

          if (this.renderer) {
            this.renderer.refresh();
            this.renderer.getCamera().animatedReset();
          }
        },

        toggleStats() {
          this.showStats = !this.showStats;
          if (this.showStats) {
            this.stats.nodes = this.graph.order;
            this.stats.edges = this.graph.size;
            this.stats.density = graphologyLibrary.metrics.graph.density(this.graph).toFixed(4);
            this.stats.avgDegree = ((2 * this.stats.edges) / this.stats.nodes).toFixed(2);
          }
        }
      }));
    });
  </script>
</body>

</html>